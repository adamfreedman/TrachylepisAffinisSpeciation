# Demographic inference

## dadi
To test the fit of a suite of demographic models to patterns of genomic variation in our sampled *T. affinis* populations, we used [dadi](https://bitbucket.org/gutenkunstlab/dadi/src/master/), a method that infers demographic history using a diffusion approximation to the allele frequency spectrum. For more details on the method see [Gutenkunst et al. 2009](https://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1000695). Dadi can compare up to three populations. We perform demographic inference for three types of models based upon broad patterns of population structure observed in our data:
* two populations: forest vs. ecotone
* two populations: populations in Southwest Province, Cameroon (SWP) vs. all other forest populations (SF)
* three populations: SWP, SF and ecotone
    * first population split between ecotone and (SWP,SF)
    * second split between SWP and SF

### Conversion to dadi format
For our analyses of empirical data, we converted our genotypes (without minor allele frequency or missingness filters; see [variant_filtering](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/tree/master/variant_filtering) for details) to dadi input format using the R package radiator version 0.0.4, using the vcf2dadi function. This function takes the vcf file and a tab-separated text "strata" file that indicates the population (stratum) to which an individual sample belongs, eg. for forest vs. ecotone, "ECO" and "FOR", implemented in this fashion:
```bash
vcf2dadi(data="oneperrad_trachylepis_RAD.vcf",strata="taffinis_dadi_strata_forVecotone.tsv",pop.levels = c("ECO","FOR"),common.markers = TRUE)
```
In later analyses we conducted simulations of genotypes for the purpose of examining F<sub>ST</sub> distributions (see below) we discovered that this function had been deprecated, and that its successor function, tidy_vcf generated unresolvable errors. I thus wrote a simple python script, [ConvertVcfToDadi.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/utilities/ConvertVcfToDadi.py) , for performing this conversion. I performed tests to confirm that, although the output order of genomic positions differs from that of vcf2dadi, the contents of the files with respect to allele counts are identical.

### Model testing framework
We used, with modifications, an interative model-fitting and permuting approach for estimating model fit and obtaining demographic parameter estimates, developed by Daniel Portik, [dadi_pipeline](https://github.com/dportik/dadi_pipeline), which we downloaded on 18 September 2017. Subsequent incorporation of goodness-of-fit tests was based upon an updated code base downloaded on 6 December 2018. This pipeline has been used in several papers investigating evolutionary processes in Afrotropical amphibians including [Portik *et al.* 2017, *Molecular Ecology*](https://onlinelibrary.wiley.com/doi/10.1111/mec.14266), [Barratt *et al.* 2018, *Molecular Ecology*], and [Charles *et al.* 2018, *Journal of Biogeography*](https://onlinelibrary.wiley.com/doi/abs/10.1111/jbi.13365), and we use many of the built-in models which are designed to represent common, competing evolutionary hypotheses for African rainforest taxa. In the models directory, We provide all models used, including additional models, and modifications to those provided in the pipeline. Besides changes to parameter setttings relevant to particular aspects of our data set, we modify one aspect of the core code used for model fitting, namely using linear rather than logarithmic scaling, as per a [google group post by Ryan Gutenkunst](https://groups.google.com/g/dadi-user/c/QiDaXxAj7bg) linear scaling can be more stable, and this eliminated errors we observed during initial testing.  

### Initial models
#### Forest vs. Ecotone
A first step in using dadi is to identify a down-projection of the input data that aims to maximize the number of variable sites, while filtering out sites with high levels of missingness. Using the dadi_2D_00_projections.py script from the Portik pipeline, we provided as input several combinations of allele counts representing fractions of the diploid numbers for individuals from each population. Using this script, we selected allele counts of 91 and 215 for ecotone and forest, respectively. We evaluated 15 different models including no_divergence and models 1-14 in [Models_2D.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/dadi_scripts_and_models/Models_2D.py). In this first set of exploratory analyses, we used "coarse" grid settings for estimating the SFS using the diffusion approximation. This approach is computationally faster and can give robust comparisons of relative model fit at the cost of lower precision of parameter estimates. Thus, in our first round of model fitting with [dadi_2D_01_optimization_round1_ForestVsEcotone_coarsegrid_15models.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/dadi_scripts_and_models/forest_vs_ecotone/dadi_2D_01_optimization_round1_ForestVsEcotone_coarsegrid_15models.py), we set pts = [50,60,70]. The second round of model fitting carries over the optimized estimates from the best replicate(with the lowest AIC score) from round 1, and the third and final round of model fitting carries over estimates from round2. Round two is executed with [dadi_2D_02_optimization_round2_ForestVsEcotone_coarsegrid_15models.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/dadi_scripts_and_models/forest_vs_ecotone/dadi_2D_02_optimization_round2_ForestVsEcotone_coarsegrid_15models.py) and round three is executed with [dadi_2D_03_optimization_round3_ForestVsEcotone_coarsegrid_15models.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/dadi_scripts_and_models/forest_vs_ecotone/dadi_2D_03_optimization_round3_ForestVsEcotone_coarsegrid_15models.py). The results from these analyses were used to guide how we structured and parameterized forest-ecotone dynamics in three-population models.
### Intra-forest (SWP vs. SF)
Similar to our analysis of forest vs. ecotone, we performed a coarse-grid model-fitting analysis for the two major genetic clusters detected among the forest populations. The purpose of these models were to identify a subset of evolutionary processes within the forest to incorporate in three-population dadi models. We removed ecotone individuals from the original vcf genotype filei with VCFTOOLS, then removed all sites invariant across the forest population individuals, retaining 43,177 SNPs. Downprojection optimization let to setting the grid parameters to pts=[144,66], and model fitting was performed with the same set of 15 models as in the forest vs. ecotone  comparisons. Scripts used to run these models are found in [SWP_vs_SF](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/tree/master/demography_models_sims/dadi_scripts_and_models/SWP_vs_SF) as part of this repository. 
### Three populations: Ecotone-SWP-SF
The models presented in [Models_3D.py](https://github.com/adamfreedman/TrachylepisAffinisSpeciation/blob/master/demography_models_sims/dadi_scripts_and_models/Models_3D.py) that comprise models found in Portik, minor modifications of those, and entirely new models to evaluate a large set of scenarios of demographic change and both intra-forest gene flow and forest-ecotone gene flow. Optimization scripts are extremely similar in structure to those for 2D models, merely calling different models, using different input files and dowprojection settings. 
### Final Forest vs Ecotone models
Despite population structure analyses revealing clear genetic subdivision within the rainforest zone, based upon AIC the two-population forest vs. ecotone models had unequivocally better support and fit to the data than the three-population models. Thus, our final round of models were for forest vs. ecotone. Because the null "no divergence" model had the worst fit to the data, we did not include this model in the final analysis. In our initial model exploration, the best fitting model indicated that gene flow had ceased between forest and ecotone, and that there had been substantial population expansions. Seeking further resolution of evolutionary processes such as repeated isolation and secondary contact over multiple epochs, consistent with refugia rather than ecotone speciation, we added an additional set of seven models (found in Models_2D.py). The only difference between the coarse grid scripts we provide and the final analyses are a) model calls to the seven additional models and b)using finer grid settings as pts = [100,110,120]. As these models took much more compute time, we modified these scripts to run each replicate for each model as a separate compute job on our cluster, and used a python sys.argv call to embed the replicate number in the output file name.  
